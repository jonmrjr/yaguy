<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Admin panel for Ask YaGuy to manage incoming questions." />
  <title>Ask YaGuy — Admin panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="api-client.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <nav>
        <div class="logo">YaGuy Admin</div>
        <ul>
          <li><a href="index.html">Public site</a></li>
          <li><a class="button button-outline" href="#admin-login">Login</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="form-page">
    <div class="container admin-layout">
      <section id="admin-login" class="form-card">
        <h1>Admin access</h1>
        <p class="helper-text">Enter the admin secret to access the internal queue. All actions are logged.</p>
        <form>
          <div class="field">
            <label for="admin-email">Email</label>
            <input id="admin-email" type="email" placeholder="admin@yaguy.com" required />
          </div>
          <div class="field">
            <label for="admin-password">Password or token</label>
            <input id="admin-password" type="password" placeholder="••••••••" required />
          </div>
          <button type="submit" class="button button-primary">Login</button>
        </form>
      </section>

      <section class="table-card">
        <div class="dashboard-header">
          <div>
            <h2>Queue</h2>
            <p class="helper-text">Filter by status and click a row to open the full brief.</p>
          </div>
          <div class="tabs" role="tablist">
            <button class="tab active" type="button">All</button>
            <button class="tab" type="button">Received</button>
            <button class="tab" type="button">In progress</button>
            <button class="tab" type="button">Answered</button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Title</th>
              <th>Status</th>
              <th>Price</th>
              <th>Created</th>
              <th>Due</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>#8F21</td>
              <td>founder@stealth.dev</td>
              <td>Hardening our custody stack</td>
              <td><span class="status-badge status-in-progress">In progress</span></td>
              <td>$99</td>
              <td>Mar 26, 2025</td>
              <td>Mar 26, 2025 18:00</td>
            </tr>
            <tr>
              <td>#8F20</td>
              <td>team@mlops.ai</td>
              <td>LLM eval automation sanity check</td>
              <td><span class="status-badge status-received">Received</span></td>
              <td>$49</td>
              <td>Mar 26, 2025</td>
              <td>Mar 27, 2025 12:00</td>
            </tr>
            <tr>
              <td>#8F19</td>
              <td>cto@finops.xyz</td>
              <td>Serverless vs containers for our batch workloads</td>
              <td><span class="status-badge status-answered">Answered</span></td>
              <td>$49</td>
              <td>Mar 25, 2025</td>
              <td>Mar 25, 2025 19:00</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="detail-card answer-section">
        <div class="status-badge status-in-progress">In progress</div>
        <h2>Hardening our custody stack</h2>
        <div class="meta-row">
          <span>Email: founder@stealth.dev</span>
          <span>Urgent (6h)</span>
          <span>Price: $99</span>
        </div>
        <p>
          Custody stack currently relies on Fireblocks + in-house monitoring. We need to validate assumptions about MPC quorum and
          create a remediation playbook for compromised operators.
        </p>
        <div class="field">
          <label for="status">Status</label>
          <select id="status">
            <option>Received</option>
            <option selected>In progress</option>
            <option>Answered</option>
            <option>Cancelled</option>
            <option>Refunded</option>
          </select>
        </div>
        <div class="answer-editor">
          <label for="answer">Answer (Markdown)</label>
          <textarea id="answer" placeholder="## TL;DR\n..."></textarea>
          <div class="hero-actions">
            <button class="button button-outline" type="button">Save Draft</button>
            <button class="button button-outline" type="button">Preview</button>
            <button class="button button-primary" type="button">Publish Answer</button>
          </div>
          <p class="helper-text">Publishing sets status to answered, timestamps delivery, and emails the user.</p>
        </div>
      </section>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-links">
        <a href="#">Terms</a>
        <a href="#">Privacy</a>
        <a href="mailto:hello@yaguy.com">Contact</a>
      </div>
      <p>Not financial or legal advice. For informational purposes only.</p>
    </div>
  </footer>

  <script>
    let currentFilter = '';
    let allQuestions = [];
    let selectedQuestion = null;

    // Check if user is logged in and is admin
    function checkAuth() {
      const user = YaGuyAPI.auth.getCurrentUser();
      if (user && user.role === 'admin') {
        document.getElementById('admin-login').style.display = 'none';
        loadQuestions();
        loadStats();
      } else {
        document.querySelector('.table-card').style.display = 'none';
        document.querySelector('.detail-card').style.display = 'none';
      }
    }

    // Load dashboard stats
    async function loadStats() {
      try {
        const result = await YaGuyAPI.admin.getStats();
        console.log('Dashboard stats:', result.stats);
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Load questions
    async function loadQuestions(status = '') {
      try {
        const filters = status ? { status } : {};
        const result = await YaGuyAPI.admin.getAllQuestions(filters);
        allQuestions = result.questions || [];
        renderQuestions();
      } catch (error) {
        console.error('Failed to load questions:', error);
        alert('Failed to load questions');
      }
    }

    // Render questions table
    function renderQuestions() {
      const tbody = document.querySelector('tbody');
      tbody.innerHTML = '';

      if (allQuestions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No questions found</td></tr>';
        return;
      }

      allQuestions.forEach(q => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.onclick = () => selectQuestion(q.id);

        const statusClass = q.status.replace('_', '-');
        const price = (q.price_cents / 100).toFixed(2);
        const created = new Date(q.created_at).toLocaleDateString();
        const due = new Date(q.due_date).toLocaleString();

        row.innerHTML = `
          <td>#${q.id.substring(0, 4)}</td>
          <td>${q.email}</td>
          <td>${q.title}</td>
          <td><span class="status-badge status-${statusClass}">${q.status}</span></td>
          <td>$${price}</td>
          <td>${created}</td>
          <td>${due}</td>
        `;

        tbody.appendChild(row);
      });
    }

    // Select and display a question
    async function selectQuestion(id) {
      try {
        const result = await YaGuyAPI.questions.getQuestion(id);
        selectedQuestion = result.question;

        const detailCard = document.querySelector('.detail-card');
        detailCard.style.display = 'block';

        const statusClass = selectedQuestion.status.replace('_', '-');
        const price = (selectedQuestion.price_cents / 100).toFixed(2);

        detailCard.querySelector('.status-badge').className = `status-badge status-${statusClass}`;
        detailCard.querySelector('.status-badge').textContent = selectedQuestion.status;
        detailCard.querySelector('h2').textContent = selectedQuestion.title;
        detailCard.querySelector('.meta-row').innerHTML = `
          <span>Email: ${selectedQuestion.email}</span>
          <span>${selectedQuestion.urgency === 'urgent' ? 'Urgent (6h)' : 'Standard (24h)'}</span>
          <span>Price: $${price}</span>
        `;
        detailCard.querySelector('p').textContent = selectedQuestion.details;
        detailCard.querySelector('#status').value = selectedQuestion.status;
        detailCard.querySelector('#answer').value = selectedQuestion.answer_text || '';
      } catch (error) {
        console.error('Failed to load question:', error);
        alert('Failed to load question details');
      }
    }

    // Handle admin login
    document.querySelector('#admin-login form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('admin-email').value;
      const password = document.getElementById('admin-password').value;

      try {
        const result = await YaGuyAPI.auth.login(email, password);
        if (result.token) {
          checkAuth();
        } else {
          alert(result.error || 'Login failed');
        }
      } catch (error) {
        console.error('Login error:', error);
        alert('Login failed');
      }
    });

    // Handle status change
    document.getElementById('status').addEventListener('change', async (e) => {
      if (!selectedQuestion) return;

      try {
        await YaGuyAPI.admin.updateQuestionStatus(selectedQuestion.id, e.target.value);
        alert('Status updated');
        loadQuestions(currentFilter);
      } catch (error) {
        console.error('Failed to update status:', error);
        alert('Failed to update status');
      }
    });

    // Handle publish answer
    document.querySelector('.button-primary').addEventListener('click', async () => {
      if (!selectedQuestion) return;

      const answer = document.getElementById('answer').value;
      if (!answer.trim()) {
        alert('Please enter an answer');
        return;
      }

      try {
        await YaGuyAPI.admin.publishAnswer(selectedQuestion.id, answer);
        alert('Answer published and email sent!');
        loadQuestions(currentFilter);
        selectQuestion(selectedQuestion.id);
      } catch (error) {
        console.error('Failed to publish answer:', error);
        alert('Failed to publish answer');
      }
    });

    // Handle tab filtering
    document.querySelectorAll('.tab').forEach((tab, index) => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const filters = ['', 'received', 'in_progress', 'answered'];
        currentFilter = filters[index];
        loadQuestions(currentFilter);
      });
    });

    // Initialize
    checkAuth();
  </script>
</body>
</html>
